# 【網羅的テスト駆動】リファクタリング計画書 (v2)

## 1. 目的と方針

### 1.1. 目的
本リファクタリングは、人間やAIエージェントによるコードの理解・確認コストを削減し、将来的な機能追加を容易にすることを目的とする。そのために、プロジェクト全体の構造を見直し、各コンポーネントの責務を明確化する。さらに、参照実装（iLoRA, DLLM2Rec）のロジックを正確に再現し、現在課題となっている教師モデルの低精度問題を解決することも目標に含める。

### 1.2. 基本方針: テスト駆動リファクタリング
まず、プロジェクトの「あるべき姿」を定義する網羅的なテストスイートを構築する。このテストスイートには、現状の実装では失敗するテストが多数含まれる。その後、全てのテストが成功（PASS）するように、アプリケーションコードを体系的にリファクタリング・修正する。このアプローチにより、変更の安全性を担保しつつ、コードの品質と正確性を飛躍的に向上させる。

### 1.3. 開発フェーズ
本計画は、手元の開発環境（GPUなし）と、実行環境（GPUあり）を想定し、以下の2フェーズで進める。

-   **CPUフェーズ:** GPUを必要としない開発・リファクタリング・テストを中心に実施する。ロジックの正確性やコード構造の改善に注力する。
-   **GPUフェーズ:** CPUフェーズで整備したコードベースを元に、GPU環境でしか実行できないテスト、モデルの完全な学習、および最終的な性能評価を行う。

---

## 2. リファクタリング計画 (ToDoリスト)

### □ ステージ0: テスト基盤の整備と現状分析
`【CPUフェーズ】`
-   [ ] **タスク0.1: 既存テストの実行と評価:**
    -   `pytest` を実行し、既存テストの成功・失敗状況を確認する。現状のコードの品質ベースラインを把握する。
-   [ ] **タスク0.2: テスト構成の強化:**
    -   `pytest.ini` または `pyproject.toml` に `pytest` の設定（テストディレクトリのパスなど）を明記する。
    -   テストの目的別にディレクトリを細分化する（例: `tests/replication`, `tests/integrity`, `tests/pipeline`）。

### □ ステージ1: 網羅的テストスイートの作成 (テストを"書く"フェーズ)
`【CPUフェーズ】`
-   [ ] **タスク1.1: 網羅的テストスイートの実装:**
    -   **内容:** `docs/refactor/test_cases.md` に定義されている、5カテゴリ・約30個の網羅的なテストケースを `tests/` 配下に実装する。
    -   **目的:** プロジェクトの「あるべき姿」をコードとして定義し、後続のリファクタリングの品質と安全性を担保するための基盤を構築する。
    -   **備考:** この段階ではテストコードを記述するのみ。GPUが必要なテストも、CPU上でスキップされるか、ダミーデータで実行される形で実装する。

### □ ステージ2: テスト駆動によるリファクタリングと修正 (CPUテストを"通す"フェーズ)
`【CPUフェーズ】`
-   [ ] **タスク2.1: CPUテストスイートの実行:**
    -   ステージ1で作成したテストのうち、CPUで実行可能な全てのテストを実行し、失敗するテストを特定する。
-   [ ] **タスク2.2: 失敗したCPUテストの修正:**
    -   失敗した各テストが成功するように、アプリケーションコード（モデル、データ処理、学習パイプラインなど）をリファクタリング・修正する。
    -   特に、`Test 1`（プロンプト形式）や`Test 10-13`（損失計算）など、性能に直結するロジック再現性テストを優先的に修正する。

### □ ステージ3: 全体構造のリファクタリング
`【CPUフェーズ】`
-   [ ] **タスク3.1: Hydra設定と初期化方法の統一**
    -   ロジックの正しさがCPUテストで担保された状態で、Hydraの手動初期化ロジックを共通化する。
-   [ ] **タスク3.2: 実験エントリーポイントの単一化**
    -   `src/exp/run_*.py` を廃止し、単一の実験実行エントリーポイント（例: `src/main.py`）を設ける。
-   [ ] **タスク3.3: 実験パイプラインの抽象化**
    -   「生徒学習」「教師学習」「蒸留」といった処理をカプセル化する `Pipeline` クラスを導入する。

### □ ステージ4: ドキュメントの整理
`【CPUフェーズ】`
-   [ ] **タスク4.1: 仕様書・引き継ぎ文書の統合:**
    -   `docs/specification` 配下の文書群を、CPUフェーズ完了時点のコードベースを反映した単一のアーキテクチャ設計書に統合・整理する。
-   [ ] **タスク4.2: 実行ガイドの更新:**
    -   `docs/specification/04_execution_guide.md` を、ステージ3で簡素化された新しい実行フローを反映するように全面的に書き直す。
-   [ ] **タスク4.3: 新しいテストスイートに関するドキュメントの作成:**
    -   `tests/README.md` を作成し、各テストの目的と前提条件、CPU/GPUの実行要件を記述する。

### □ ステージ5: GPU環境での最終検証と評価
`【GPUフェーズ】`
-   [ ] **タスク5.1: GPU必須テストの実行と修正:**
    -   ステージ1で実装したテストのうち、GPU環境でのみ実行可能なテスト（`Test 25`, `Test 27`, `Test 28`など）を実行し、パスすることを確認する。必要に応じて修正を行う。
-   [ ] **タスク5.2: モデルの完全な学習と性能評価:**
    -   全データセットを使用し、生徒ベースライン・教師モデル・蒸留モデルの学習をGPU環境で実行する。
    -   最終的な性能メトリクス（`recall@10`など）を測定し、リファクタリング前後での性能変化を確認・評価する。
-   [ ] **タスク5.3: 最終ドキュメントの更新:**
    -   最終的な性能評価結果をドキュメントに追記し、プロジェクトを完了とする。
